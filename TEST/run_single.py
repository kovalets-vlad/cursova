import pandas as pd
import numpy as np
import joblib
from keras.models import load_model
from sklearn.preprocessing import StandardScaler

# ==========================================
# 1. –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –°–ò–°–¢–ï–ú–ò
# ==========================================
print("üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è Delta-–º–æ–¥–µ–ª—ñ...")

model = load_model('cursova/cnn_delta_model.keras') 
scaler_X = joblib.load('cursova/scaler_X.pkl')        # –°–∫–µ–π–ª–µ—Ä –¥–ª—è –≤—Ö–æ–¥—É
scaler_Y = joblib.load('cursova/scaler_Y.pkl')        # –°–∫–µ–π–ª–µ—Ä –¥–ª—è –≤–∏—Ö–æ–¥—É (Delta)
feature_names = joblib.load('cursova/model_features.pkl') # –°–ø–∏—Å–æ–∫ –∫–æ–ª–æ–Ω–æ–∫

# –†–æ–∑–¥—ñ–ª—è—î–º–æ –Ω–∞–∑–≤–∏ –∫–æ–ª–æ–Ω–æ–∫ (—è–∫ –±—É–ª–æ –ø—Ä–∏ –Ω–∞–≤—á–∞–Ω–Ω—ñ)
# –õ–æ–≥—ñ–∫–∞: dynamic (8) + static (2) + weekend (1) = 11
# –ê–õ–ï scaler_X –Ω–∞–≤—á–µ–Ω–∏–π –Ω–∞ –í–°–Ü–• 11 –∫–æ–ª–æ–Ω–∫–∞—Ö –∑–ª–∏—Ç–∏—Ö —Ä–∞–∑–æ–º
print(f"–ú–æ–¥–µ–ª—å –æ—á—ñ–∫—É—î {len(feature_names)} –æ–∑–Ω–∞–∫: {feature_names}")

# ==========================================
# 2. –î–ê–ù–Ü –ù–û–í–û–ì–û –Æ–ó–ï–†–ê (–°—Ü–µ–Ω–∞—Ä—ñ–π: "–°—Ç—Ä–µ—Å–æ–≤–∏–π —Ç–∏–∂–¥–µ–Ω—å")
# ==========================================
# –°–∏–º—É–ª—é—î–º–æ –¥–∞–Ω—ñ: –õ—é–¥–∏–Ω–∞ –≤—Ç–æ–º–ª—é—î—Ç—å—Å—è, —Å–ø–∏—Ç—å –º–µ–Ω—à–µ, —Å—Ç—Ä–µ—Å —Ä–æ—Å—Ç–µ
# –°—Ü–µ–Ω–∞—Ä—ñ–π: 48 –≥–æ–¥–∏–Ω –±–µ–∑ —Å–Ω—É + —à–∞–ª–µ–Ω–∏–π —Å—Ç—Ä–µ—Å
data = {
    'steps': [5000, 4000, 3000, 2000, 1000, 5080, 5008], # –ü—Ä–∏—Ä—ñ—Å –¥–æ –∫—Ä—ñ—Å–ª–∞
    'very_active_minutes': [0, 0, 0, 0, 0, 0, 10],
    
    # –ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞ –∑—ñ —Å–Ω–æ–º: 8 –≥–æ–¥ -> 4 –≥–æ–¥ -> 0 –≥–æ–¥ (—Å—É—Ç–∫–∏ –Ω–µ —Å–ø–∞–≤)
    'minutesAsleep': [480, 450, 400, 300, 440, 420, 480], 
    'sleep_efficiency': [95, 90, 85, 80, 70, 50, 50],
    
    # –°–µ—Ä—Ü–µ –∫–∞–ª–∞—Ç–∞—î –Ω–∞–≤—ñ—Ç—å —É —Å–ø–æ–∫–æ—ó (–∫–∞–≤–∞/–µ–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏)
    'nremhr': [55, 56, 58, 60, 65, 60, 60], 
    
    'stress_score': [20, 30, 40, 60, 50, 25, 20], # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Å—Ç—Ä–µ—Å
    'nightly_temperature': [36.6] * 7, # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–æ—Ä–º
    'resting_hr': [55, 55, 56, 58, 60, 55, 50], # –í–∂–µ —Ä–æ–∑—ñ–≥–Ω–∞–Ω–∏–π –ø—É–ª—å—Å
    
    'age': [25] * 7,
    'bmi': [24] * 7,
    'is_weekend': [0] * 7
}

# –°—Ü–µ–Ω–∞—Ä—ñ–π: "–†–∞–ø—Ç–æ–≤–∏–π —É–¥–∞—Ä" (Sudden Shock)
df = pd.DataFrame(data)

# ==========================================
# 3. –ü–Ü–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ò–• 
# ==========================================

print("‚öñÔ∏è –û–±—Ä–æ–±–∫–∞ –¥–∞–Ω–∏—Ö...")

dynamic_cols = [
    'steps', 'very_active_minutes', 'minutesAsleep', 'sleep_efficiency', 
    'nremhr', 'stress_score', 'nightly_temperature', 'resting_hr'
]
static_cols = ['age', 'bmi']
weekend_col = ['is_weekend']

# 1. –î–∏–Ω–∞–º—ñ–∫–∞ -> Z-score
dyn_data = df[dynamic_cols].values
dyn_scaled = scaler_X.transform(dyn_data) # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π

# 2. –°—Ç–∞—Ç–∏–∫–∞ -> –î—ñ–ª–µ–Ω–Ω—è
stat_data = df[static_cols].values
stat_data[:, 0] = stat_data[:, 0] / 100.0
stat_data[:, 1] = stat_data[:, 1] / 50.0

# 3. Weekend
week_data = df[weekend_col].values

# 4. –°–∫–ª–µ—é—î–º–æ
final_input = np.hstack((dyn_scaled, stat_data, week_data))

# –ë–µ—Ä–µ–º–æ –≤—ñ–∫–Ω–æ (–æ—Å—Ç–∞–Ω–Ω—ñ 3 –¥–Ω—ñ)
time_steps = 3
X_window = final_input[-time_steps:].reshape(1, time_steps, final_input.shape[1])

# ==========================================
# 4. –ü–†–û–ì–ù–û–ó –¢–ê –†–ï–ö–û–ù–°–¢–†–£–ö–¶–Ü–Ø
# ==========================================
print("üß† –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ø—Ä–æ–≥–Ω–æ–∑—É...")

# 1. –ü—Ä–æ–≥–Ω–æ–∑ –∑–º—ñ–Ω–∏ (Z-score)
pred_delta_z = model.predict(X_window, verbose=0)

# 2. –Ü–Ω–≤–µ—Ä—Å—ñ—è –∑–º—ñ–Ω–∏ (BPM)
pred_delta_bpm = scaler_Y.inverse_transform(pred_delta_z)[0][0]

# 3. –†–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è
today_bpm = df['resting_hr'].iloc[-1] # –û—Å—Ç–∞–Ω–Ω—î –≤—ñ–¥–æ–º–µ –∑–Ω–∞—á–µ–Ω–Ω—è (58)
tomorrow_bpm = today_bpm + pred_delta_bpm

print("\n" + "="*40)
print(f"   –ê–ù–ê–õ–Ü–ó –í–Ü–î–ù–û–í–õ–ï–ù–ù–Ø (Delta AI)")
print("="*40)
print(f"–ü–æ—Ç–æ—á–Ω–∏–π –ø—É–ª—å—Å: {today_bpm:.1f} BPM")
print(f"–ó–º—ñ–Ω–∞ (Delta):  {pred_delta_bpm:+.2f} BPM")
print(f"–ü–†–û–ì–ù–û–ó:        {tomorrow_bpm:.1f} BPM")
print("-" * 20)

# ==========================================
# 5. –ü–û–Ø–°–ù–ï–ù–ù–Ø (–ß–û–ú–£?)
# ==========================================
# –ê–Ω–∞–ª—ñ–∑—É—î–º–æ Z-scores –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –¥–Ω—è (–ø–µ—Ä—à—ñ 8 –∫–æ–ª–æ–Ω–æ–∫)
last_day_stats = X_window[0, -1, :8]

# –Ü–Ω–¥–µ–∫—Å–∏: 2=Sleep, 5=Stress, 6=Temp
reasons = []
if last_day_stats[5] > 0.8: reasons.append("–≤–∏—Å–æ–∫–∏–π —Ä—ñ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—É")
if last_day_stats[2] < -0.8: reasons.append("–Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—é –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–Ω—É")
if last_day_stats[6] > 1.0: reasons.append("–ø—ñ–¥–≤–∏—â–µ–Ω—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É —Ç—ñ–ª–∞")
if last_day_stats[1] > 1.5: reasons.append("–≤–∏—Å–æ–∫–µ —Ñ—ñ–∑–∏—á–Ω–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è")

if pred_delta_bpm > 0.5:
    reason_text = " —Ç–∞ ".join(reasons) if reasons else "–Ω–∞–∫–æ–ø–∏—á–µ–Ω—É –≤—Ç–æ–º—É"
    print(f"üìâ –¢–ï–ù–î–ï–ù–¶–Ü–Ø: –ü–æ–≥—ñ—Ä—à–µ–Ω–Ω—è. –ü—É–ª—å—Å –∑—Ä–æ—Å—Ç–µ —á–µ—Ä–µ–∑ {reason_text}.")
    print("–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è: –ó–Ω–∏–∑–∏—Ç–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, –ª—è–≥—Ç–∏ —Å–ø–∞—Ç–∏ —Ä–∞–Ω—ñ—à–µ.")
    
elif pred_delta_bpm < -0.5:
    print(f"üìà –¢–ï–ù–î–ï–ù–¶–Ü–Ø: –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è! –í–∞—à–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –π–¥–µ —á—É–¥–æ–≤–æ.")
    
else:
    print(f"‚û°Ô∏è –°–¢–ê–ë–Ü–õ–¨–ù–Ü–°–¢–¨: –°—Ç–∞–Ω –æ—Ä–≥–∞–Ω—ñ–∑–º—É –±–µ–∑ —Å—É—Ç—Ç—î–≤–∏—Ö –∑–º—ñ–Ω.")